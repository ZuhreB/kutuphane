<!DOCTYPE html>
<html lang="tr" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="contentFragment">
  <h2>Yeni Kitap Ekle</h2>
  <hr>

  <!-- Başarı veya hata mesajları için alan -->
  <div id="message-container" style="display:none;"></div>

  <form id="add-book-form" class="styled-form">
    <div class="form-group">
      <label for="title">Başlık:</label>
      <input type="text" id="title" name="title" class="form-control" required>
    </div>

    <div class="form-group">
      <label for="authorId">Yazar:</label>
      <select id="authorId" name="authorId" class="form-control" required>
        <option value="">Yazar Seçiniz</option>
        <option th:each="author : ${authors}" th:value="${author.authorID}" th:text="${author.firstName + ' ' + author.lastName}"></option>
      </select>
    </div>

    <div class="form-group">
      <label for="publisherId">Yayıncı:</label>
      <select id="publisherId" name="publisherId" class="form-control" required>
        <option value="">Yayıncı Seçiniz</option>
        <option th:each="publisher : ${publishers}" th:value="${publisher.publisherID}" th:text="${publisher.publisherName}"></option>
      </select>
    </div>

    <div class="form-group">
      <label for="isbn">ISBN:</label>
      <input type="text" id="isbn" name="isbn" class="form-control" required>
    </div>

    <div class="form-group">
      <label for="totalCopies">Toplam Kopya Sayısı:</label>
      <input type="number" id="totalCopies" name="totalCopies" class="form-control" required min="1">
    </div>

    <div class="form-group">
      <label for="description">Açıklama:</label>
      <textarea id="description" name="description" class="form-control" rows="3"></textarea>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">Kitabı Kaydet</button>
    </div>
  </form>

  <script>
    document.getElementById('add-book-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Sayfanın yenilenmesini engelle

        const messageContainer = document.getElementById('message-container');
        const formData = new FormData(event.target);

        // --- ISTEMCI TARAFI DOĞRULAMA (CLIENT-SIDE VALIDATION) ---
        // Sunucuya istek göndermeden önce yazar ve yayıncının seçildiğinden emin ol.
        const authorId = formData.get('authorId');
        const publisherId = formData.get('publisherId');

        if (!authorId || !publisherId) {
            messageContainer.style.display = 'block';
            messageContainer.className = 'alert alert-danger';
            messageContainer.textContent = 'Hata: Lütfen bir yazar ve yayıncı seçiniz.';
            return; // Fonksiyonu burada durdur, sunucuya istek gönderme.
        }

        // --- VERİ HAZIRLAMA ---
        const bookData = {
            title: formData.get('title'),
            isbn: formData.get('isbn'),
            totalCopies: parseInt(formData.get('totalCopies'), 10),
            description: formData.get('description'),
            // KRİTİK DÜZELTME: Backend'deki Java Entity'si ile eşleşen doğru alan adlarını (authorID, publisherID) gönder.
            // Yukarıda doğrulanan ID'leri kullan.
            author: { authorID: parseInt(authorId, 10) },
            publisher: { publisherID: parseInt(publisherId, 10) }
        };

        // Backend'e POST isteği gönder
        fetch('/api/books/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(bookData)
        })
        .then(response => response.json())
        .then(data => {
            messageContainer.style.display = 'block';

            if (data.success) {
                messageContainer.className = 'alert alert-success';
                messageContainer.textContent = data.message;
                event.target.reset(); // Formu temizle
            } else {
                messageContainer.className = 'alert alert-danger';
                messageContainer.textContent = 'Hata: ' + data.message;
            }
        })
        .catch(error => {
            console.error('Fetch Error:', error);
            messageContainer.style.display = 'block';
            messageContainer.className = 'alert alert-danger';
            messageContainer.textContent = 'İstek gönderilirken bir ağ hatası oluştu.';
        });
    });
  </script>
</div>

</body>
</html>