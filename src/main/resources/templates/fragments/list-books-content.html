<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="contentFragment">
    <h2>Kitap Listesi</h2>

    <div id="message-container" class="alert" style="display:none;">
        <span id="message-text"></span>
    </div>

    <table class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Başlık</th>
            <th>Yazar</th>
            <th>Yayıncı</th>
            <th>ISBN</th>
            <th>Yayın Yılı</th>
            <th>Toplam Kopya</th>
            <th>Mevcut Kopya</th>
            <th>İşlemler</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="book : ${books}">
            <td th:text="${book.bookID}"></td>
            <td th:text="${book.title}"></td>
            <td th:text="${book.author?.firstName + ' ' + book.author?.lastName}"></td>
            <td th:text="${book.publisher?.publisherName}"></td>
            <td th:text="${book.isbn}"></td>
            <td th:text="${book.publicationYear}"></td>
            <td th:text="${book.totalCopies}"></td>
            <td th:text="${book.availableCopies}"></td>
            <td>
                <button type="button"
                        class="btn btn-danger btn-sm delete-book-btn"
                        th:data-book-id="${book.bookID}">
                    Sil
                </button>
            </td>
        </tr>
        </tbody>
    </table>
    <script th:inline="javascript">
        function initializeBookDelete() {
            console.log("initializeBookDelete fonksiyonu list-books-content.html'den çağrıldı!");
            const deleteButtons = document.querySelectorAll('.delete-book-btn');
            const messageContainer = document.getElementById('message-container');
            const messageText = document.getElementById('message-text');

            deleteButtons.forEach(button => {
                if (!button.dataset.listenerAttached) {
                    button.addEventListener('click', async (e) => {
                        // 🛠️ BURADAKİ YENİ KONTROL: e.currentTarget'ın geçerli bir element olduğundan emin olun
                        if (!e.currentTarget || !(e.currentTarget instanceof Element)) {
                            console.error('Hata: Olay hedefi (e.currentTarget) geçersiz veya null. Silme işlemi iptal edildi.');
                            return; // İşlemi durdur
                        }

                        const bookId = e.currentTarget.dataset.bookId;

                        if (!bookId) {
                            console.error('Book ID silme işlemi için bulunamadı.');
                            return;
                        }
                        console.log("Kitap ID:", bookId, "silmeye çalışılıyor.");

                        const confirmDelete = confirm('Bu kitabı silmek istediğinizden emin misiniz?');
                        if (!confirmDelete) {
                            return;
                        }

                        try {
                            const response = await fetch(`/employee/books/delete/${bookId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });

                            const data = await response.json();

                            messageContainer.style.display = 'block';
                            messageContainer.classList.remove('alert-success', 'alert-danger');

                            if (response.ok) {
                                messageContainer.classList.add('alert-success');
                                messageText.textContent = data.message;

                                // 🛠️ BURADAKİ YENİ KONTROL: Satırı kaldırmadan önce varlığını kontrol edin
                                const rowToRemove = e.currentTarget.closest('tr');
                                if (rowToRemove) {
                                    rowToRemove.remove();
                                } else {
                                    console.warn("Uyarı: Silinecek tablo satırı DOM'da bulunamadı. Sayfa yenilemesi gerçekleşecek.");
                                }

                                setTimeout(() => {
                                     window.location.reload();
                                 }, 1500);
                            } else {
                                messageContainer.classList.add('alert-danger');
                                messageText.textContent = data.message || 'Kitap silinirken bir hata oluştu.';
                            }
                        } catch (error) {
                            console.error('Fetch işlemi sırasında hata:', error);
                            messageContainer.style.display = 'block';
                            messageContainer.classList.remove('alert-success');
                            messageContainer.classList.add('alert-danger');
                            messageText.textContent = 'Ağ hatası veya sunucuya ulaşılamıyor.';
                        }
                    });
                    button.dataset.listenerAttached = 'true';
                }
            });
        }

        initializeBookDelete();
    </script>
</div>
</body>
</html>