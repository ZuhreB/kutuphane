<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="contentFragment">
    <h2>Kitap Listesi</h2>

    <div id="message-container" class="alert" style="display:none;">
        <span id="message-text"></span>
    </div>

    <table class="table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Başlık</th>
            <th>Yazar</th>
            <th>Yayıncı</th>
            <th>ISBN</th>
            <th>Yayın Yılı</th>
            <th>Toplam Kopya</th>
            <th>Mevcut Kopya</th>
            <th>İşlemler</th>
        </tr>
        </thead>
        <tbody id="books-table-body"> <!-- Add ID for easier access if needed -->
        <tr th:each="book : ${books}" th:id="'book-row-' + ${book.bookID}">
            <td th:text="${book.bookID}"></td>
            <td th:text="${book.title}"></td>
            <td th:text="${book.author?.firstName + ' ' + book.author?.lastName}"></td>
            <td th:text="${book.publisher?.publisherName}"></td>
            <td th:text="${book.isbn}"></td>
            <td th:text="${book.publicationYear}"></td>
            <td th:text="${book.totalCopies}"></td>
            <td th:text="${book.availableCopies}"></td>
            <td>
                <button type="button"
                        class="btn btn-danger btn-sm delete-book-btn"
                        th:data-book-id="${book.bookID}">
                    Sil
                </button>
            </td>
        </tr>
        </tbody>
    </table>

    <script th:inline="javascript">
        // BEST PRACTICE: Use a single event listener on the table (Event Delegation).
        // This is more efficient and works even if new rows are added dynamically.
        document.querySelector('.table').addEventListener('click', async (event) => {
            // Only proceed if a delete button was clicked
            if (!event.target.classList.contains('delete-book-btn')) {
                return;
            }

            const button = event.target;
            const bookId = button.dataset.bookId;
            const messageContainer = document.getElementById('message-container');
            const messageText = document.getElementById('message-text');

            if (!bookId) {
                console.error('Book ID could not be found on the button.');
                return;
            }

            if (!confirm('Bu kitabı (ID: ' + bookId + ') silmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                // KRİTİK DÜZELTME: Standart REST API adresini kullanın.
                // Backend'deki BookController'ınızın @DeleteMapping("/{id}") ve @RequestMapping("/api/books") kullandığından emin olun.
                const response = await fetch(`/employee/books/delete/${bookId}`, {
                    method: 'DELETE'
                });

                // ÖNCE YANITIN DURUMUNU KONTROL ET
                if (response.ok) {
                    // Başarılı! Kitap silindi. Sunucudan gelen body boş olsa bile bu blok çalışır.
                    messageContainer.style.display = 'block';
                    messageContainer.className = 'alert alert-success'; // Reset classes and add success
                    messageText.textContent = 'Kitap (ID: ' + bookId + ') başarıyla silindi.';

                    // Satırı DOM'dan kaldır
                    const rowToRemove = document.getElementById('book-row-' + bookId);
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                } else {
                    // Sunucu bir hata kodu döndürdü (4xx, 5xx). Hata mesajını JSON olarak almaya çalış.
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Bilinmeyen bir sunucu hatası oluştu.');
                }

            } catch (error) {
                // Bu blok, ağ hatası olduğunda VEYA yukarıda bizim fırlattığımız hata (`throw new Error`) durumunda çalışır.
                console.error('Silme işlemi sırasında hata:', error);
                messageContainer.style.display = 'block';
                messageContainer.className = 'alert alert-danger';
                messageText.textContent = error.message || 'Ağ hatası veya sunucuya ulaşılamıyor.';
            }
        });
    </script>
</div>
</body>
</html>